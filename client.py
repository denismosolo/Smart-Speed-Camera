#need to install python libraries on raspberry pi client
import socketio
from encrypt_decrypt_packet import create_encrypted_packet
import os
from termcolor import colored
import threading
import time

os.system('color')


l_public_key = {'WM562WT1FM':(65537, 23147846205165813158546568265533926296681866170719041773573608759142646823679548403608820074698239401737642557542734329881716054346165574862256293755381243069695477281902320708609170252722592933457768238376177017014452267658050215751352077700351770697740306381271965945060899765401243065247337651453105367511801280035341241154332636021854445207503499779361090036337227181242945590405924617659128608585100340554516063798474092971799598142998163179216989031526139090397037663036358513537032051779596079781115246932610675365536626485954544454098906005356583722355905893304142135751196426308279057068576121564102565230857),
                'HO781EI7BK':(65537, 16663465423596519513395549711156777172262037372813817828194576368951971279765778872921423251125074355132167608988622603233170860727946429471557149603503679805947990174554394967909209941504564706687996087899632576119332218041301133913620854580350577469166802414811797397791434501813625338205714570090278347775596470609200721846570984485888255858026187198989421356736127317847835757774320041634522289257406510936459674450225329400582451381593756647161586375489583374489116758595424849272171178020946130180735715474837265206856096793896248374903803979473183338571481705240948865343969938821142719318610242894211137782121),
                'HE814DH6WK':(65537, 26436204286626740132965213710099772965325920741703071673470791918700228442125922405253990910105237939675411866762120357688135404932513956977948476103802283510046136724127845714003121607087663317445957385821016512490015772199122281407752025875398927809410922160416769878184633495361807313036856645146562681798424778147730939114464749752542848043962017754637480127734635667874539690200115159953391640501622106391477991240008025806852543481164094936147815285779242358850809806200014695482566051976711248059552461756384648976554878163632352308390028220172521564785661053086261475632322749882307332822318378773854833064283),
                'UO321ZL7NW':(65537, 22720129394334359605629356363723362108321959144143832192891001269724986310132589033351454211014277134730242110335213669171031880282668670046755152995806538786188890128473682727740658874294453623303104696984052079947776108450159111862800631409911687008673522302976643491536778024741692995777435345140532192464888354834766566033901501813580164638604470013831689508191040176851277839403187462992456948280616821881076770579140896746732544826347612147032789230404505764481395213786526216064878913614401600314062479079088345765312405095317060824842971906853113373745355062491546677423280690675340792439910861967255443202393),
                'JL682MH1PT':(65537, 25626254138151134760192482069969981250030471410468384874620273393382907429660392936409398335884523252461108539524227478398641818189847529296235265662887817969994449522795011691799770167049480538231224313970540712461338345078823438933810779319950691506670139471550227989233539065381289095868052961715456795460459693465733340723050649486007510823350518849546340533895426699838527827530948480514808921043198998715109575129546273824944099150023399592921026015736767573923524744162139239592739692732100533324124733289325438780474520441381189457801546984652961993346993296577522497091398997390629177212280650262494619844839),
                'YJ478NW6SD':(65537, 26478258392971572253216600657225428925996852392420757375532078080188962077755758094010071641770783522340185809493236464207451282316512829094431761909704373662623327249279453956899763520409030966581716340530395945915188078753469989632105020372144838241233860044907290492625862304395965242161237256622543179955403096742467608374753232325898427503773571835844315515985253093231319600816431692041404800411964913535461029521238050821270215133664235516209651743350062542326238845126740267240238699607555324805656617568692784677511407980778256643991610475623372383617846403675814954982229394949645069234617439147507538768637),
                'DY665QL6AU':(65537, 23311326865531696675762641185798592972584442509443550339548198899545439607281409455903529292231496983323659444616685312710107113384870636714790258372745065667017940878369944606775029205689207346259093155786556366056094558601516628750864611868060245936123348955977460279544768396193829043602471655522547294305589541467069053249292554945633316051507955791576696717035288393831027498017659933384799209027363267016753685316492189060928430244443384231428060480377750602190245765383882543326209910254171641273128816101545062450752230529797113131587317321388854770681822355533576462434017361776376899558748678598561275949771),
                'TU334QD1KS':(65537, 17733441141837889390805572448611232804146482441255869085953360069757946324836525497412239847038127391773096754810701971359724685108286639444304224348588757507173426608803944785067762414127224614624001148027190362659107276297469689424776305015379966080798862350790644785034831142972925174585432766129747572916338016113457593518118336450943884636774008623252293366395356310861387735720220861877184224250241315820709314640006066694076587727103019832550696980382094809796743889928832704258576719950766166288123003422925925516248580030616185156325123286877713453144016870616033067877604615282281283686880291935840099628417),
                'ND742XB5CW':(65537, 30874606581952115552266036492445707776557817744001616182759889021790632142097780002111516673789486785562464977427702785664475357935545533156984816323798528406758953725146017070634325815424064250667993784848309573419441026741186892058078138815703519109787148254866206490063109592529516952505452840998290643501949337180698862748950072845320179997239561694630873909515000959326016552905532841072166742354230494241917454903842500812680458248810273362291528455772223340555015395460870640869360520149096217975969627631760397394545629613952426675619774634984829771390481876914857095900253633685482351958255637503005017139333),
                'AN321WM1ER':(65537, 24899423898517820507567411223626758121271204578933115860294546439444801095241837707974122373716897386141706150442885761919638579813178403692907536547262128269712946459788304872517379555658163882617570604593269523916939674858429799433244706378604589198927328984027725515203960515594721744522455759675470289660635073688085295331096648454283106358211277821971005936870527579633307614133859498463658281167851271383626412719494250736593916929088955313489412322472892369453665341593779825302410164790403484840967508840799545085031383124768155796075645571900205135407392898752829391152626525953109288875079786968596391459809)}

l_targa = ['EX539MT','EZ841TX','FB911NT','FK789EP','FP858MS','FS332VE','FT889TT','FX796HL','FX923HL','FY154KA']
l_codice_patente = ['UD1234567A','UD2345678B','UD3456789C','UD4567890D','UD5678901E','UD6789012F','UD7890123G','UD8901234H','UD9012345I','UD0123456J']

i=0

def client(targa, codice_patente, e, n, id):
    sio = socketio.Client()

    def send_packet(packet):
        while True:
            print(colored('packet sent', 'yellow'))
            try:
                sio.call('packet', packet, timeout=1)
            except TimeoutError:
                pass
            else:
                print(colored('ack received', 'yellow'))
                sio.disconnect()
                #print(colored('disconnected from server', 'green'))
            if not sio.connected:
                break

    @sio.event
    def connect():
        print(colored('connection established', 'green'))
        sio.emit('requesting nonce')

    @sio.event
    def disconnect():
        print(colored('disconnected from server', 'green'))

    @sio.event
    def nonce(nonce):
        print(colored(f'nonce received: {nonce}', 'yellow'))
        packet = create_encrypted_packet(targa, codice_patente, e, n, id, nonce)
        sio.start_background_task(send_packet(packet))

    # IP address of the server, make sure port is open on RaspPi
    sio.connect('http://192.168.1.172:5000')


#client('ER804SX','UD1234567A',l_public_key['WM562WT1FM'][0],l_public_key['WM562WT1FM'][1], 'WM562WT1FM')


while i<10:
    targa = l_targa[i]
    codice_patente = l_codice_patente[i]
    secretID = list(l_public_key.items())[i][0]
    e = l_public_key[secretID][0]
    n = l_public_key[secretID][1]
    x = threading.Thread(target=client, args=(targa, codice_patente, e, n, secretID))
    x.start()
    time.sleep(3)
    i=i+1